<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Roadmap × 勝率 設定面板（自動帶入）</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<style>
  :root{ --bg:#0f172a; --card:#0b1220; --muted:#94a3b8; --grid:#d1d5db; --grid-dark:#334155; --red:#e11d48; --blue:#2563eb; --green:#10b981; }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:#e5e7eb; font-family:"Microsoft JhengHei",system-ui,-apple-system,ui-sans-serif,Segoe UI,Roboto,Noto Sans TC,Arial}
  header{padding:10px 14px; background:#0b1220; border-bottom:1px solid #1f2937; position:sticky; top:0; z-index:10}
  .wrap{max-width:1800px; margin:0 auto; padding:14px}
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .grow{flex:1}
  button{appearance:none; border:0; border-radius:10px; padding:10px 14px; font-weight:600; color:#fff; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,.25); transition:.2s transform ease}
  .btn{background:#64748b} .btn:active{transform:translateY(1px)}
  .btn-b{background:var(--red)} .btn-p{background:var(--blue)} .btn-t{background:var(--green)}
  .btn-on{background:#22c55e}
  .stat{font-size:12px; color:#94a3b8}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  iframe{width:100%; height:86vh; border:1px solid #1f2937; border-radius:12px; background:#0b1220}
  /* Left Roadmap (inline minimized version) */
  .road{ background:#fff; border-radius:10px; padding:8px; border:1px solid var(--grid-dark); overflow:auto; }
  .cell{ width:22px; height:22px; border:1px solid var(--grid); position:relative; }
  .grid{ display:grid; gap:0; }
  .disc{ border-radius:50%; width:16px; height:16px; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
  .disc.red{ background:var(--red) } .disc.blue{ background:var(--blue) }
  .tieMark{ position:absolute; right:1px; top:1px; width:6px; height:6px; background:var(--green); border-radius:50%; box-shadow:0 0 0 2px #fff; }
  .panel{background:#111827; border:1px solid #1f2937; border-radius:12px; padding:10px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="row">
        <button class="btn-b" onclick="add('B')">莊</button>
        <button class="btn-p" onclick="add('P')">閒</button>
        <button class="btn-t" onclick="add('T')">和</button>
        <button class="btn" onclick="undo()">復原</button>
        <button class="btn" onclick="reset()">清空</button>
      </div>
      <div class="grow"></div>
      <div class="row">
        <button id="autoBtn" class="btn" onclick="toggleAuto()">自動帶入：關</button>
        <button class="btn" onclick="adoptNow()">採用目前預測</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid2">
    <!-- Left: Roadmap board -->
    <div class="panel">
      <div style="font-weight:700; margin:4px 0 8px 2px">路圖（自動帶入預測）</div>
      <div class="road"><div id="board" class="grid"></div></div>
      <div class="stat" id="stat"></div>
    </div>
    <!-- Right: Probability Calculator iframe -->
    <iframe id="calc" src="https://pox1028-dev.github.io/baccarat-pwa/?v=42-offline"></iframe>
  </div>
</div>

<script>
  // --- simple 6x32 main road for demo ---
  const ROWS=6, COLS=32; const boardEl = document.getElementById('board');
  boardEl.style.gridTemplateColumns = `repeat(${COLS}, 22px)`; boardEl.style.gridTemplateRows=`repeat(${ROWS}, 22px)`;
  let lastPos=null,lastColor=null; let seq=[];
  const statEl = document.getElementById('stat');
  function paint(){
    statEl.textContent = '已記錄：' + seq.join(' ');
    const grid = Array.from({length:ROWS},()=>Array(COLS).fill(''));
    let row=0,col=0; lastPos=null; lastColor=null;
    for(const r of seq){
      if(r==='T'){ if(lastPos){ grid[lastPos.row][lastPos.col] += 'T'; } continue; }
      if(!lastColor){ grid[row][col]=r; lastColor=r; lastPos={row,col}; continue; }
      if(r===lastColor){ if(lastPos.row+1<ROWS && !grid[lastPos.row+1][lastPos.col]){ row=lastPos.row+1; col=lastPos.col; } else { row=lastPos.row; col=lastPos.col+1; while(col<COLS && grid[row][col]) col++; } }
      else{ row=0; col=lastPos.col+1; while(col<COLS && grid[row][col]) col++; lastColor=r; }
      if(col<COLS){ grid[row][col]=r; lastPos={row,col}; }
    }
    boardEl.innerHTML='';
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const v=grid[r][c];
        const cell=document.createElement('div'); cell.className='cell';
        if(v.includes('B')||v.includes('P')){
          const d=document.createElement('div'); d.className='disc ' + (v.includes('B')?'red':'blue'); cell.appendChild(d);
        }
        if(v.includes('T')){ const t=document.createElement('div'); t.className='tieMark'; cell.appendChild(t); }
        boardEl.appendChild(cell);
      }
    }
  }
  function add(x){ seq.push(x); paint(); }
  function undo(){ seq.pop(); paint(); }
  function reset(){ if(confirm('清空？')){ seq=[]; paint(); } }
  paint();

  // --- Auto adopt from iframe ---
  const calcFrame = document.getElementById('calc');
  let autoOn=false, lastPick='';
  function toggleAuto(){ autoOn=!autoOn; document.getElementById('autoBtn').textContent = '自動帶入：' + (autoOn?'開':'關'); if(autoOn) document.getElementById('autoBtn').classList.add('btn-on'); else document.getElementById('autoBtn').classList.remove('btn-on'); }
  function adoptNow(){ const pick = readPick(); if(pick) add(pick); else alert('讀不到預測，請先在右側按「計算」'); }
  function readPick(){
    try{
      const doc = calcFrame.contentWindow.document;
      const text = doc.body.innerText || '';
      // 試著抓「Banker」「Player」「Tie」相對應的百分比
      const b = (/Banker\D+(\d+(?:\.\d+)?)%/.exec(text) || /莊[^\d]*(\d+(?:\.\d+)?)%/.exec(text));
      const p = (/Player\D+(\d+(?:\.\d+)?)%/.exec(text) || /閒[^\d]*(\d+(?:\.\d+)?)%/.exec(text));
      if(b && p){
        const bp = parseFloat(b[1]), pp = parseFloat(p[1]);
        return bp>pp?'B':'P';
      }
    }catch(e){
      console.warn('讀不到 iframe 內容（可能同源限制）', e);
    }
    return '';
  }
  setInterval(()=>{
    if(!autoOn) return;
    const pick = readPick();
    if(pick && pick!==lastPick){
      lastPick=pick;
      add(pick);
    }
  }, 1500);
</script>
</body>
</html>
